---
title: "CPI Motor Change Prediction"
author: "Ozgur"
date: "2024-12-23"
output: html_document
---

## Preparing Variables

The variables I will use in the beginning:
  - Monthly Change of CPI Motor
  - Monthly Change of Oil and Gasoline Futures
  - Daily volatility of Oil and Gasoline Futures
  - Weekly volatility of Oil and Gasoline Futures 

To remove any leakage, split the data to train models and test at the beginning  of 2003. I will report the predictions for the monthly CPI-motor changes starting Jan 2023.  

```{r importing}
library(tidyverse)
library(dynlm)

data <- readRDS("data/preppedData.rds")
data <- data %>% mutate(Change_CPI = log(CPI_Motor) - log(lag(CPI_Motor)),
                        Change_OilPrice = log(OilMonthlyAverage) - log(lag(OilMonthlyAverage)),
                        Change_GasPrice = log(GasolineFutureMonthly) - log(lag(GasolineFutureMonthly)),
                        Change_OilVolDaily = log(Oil_Volatility_Daily) - log(lag(Oil_Volatility_Daily)),
                        Change_GasVolDaily = log(Gasoline_Volatility_Daily) - log(lag(Gasoline_Volatility_Daily)))
  
data_train <- data %>% filter(Year < 2023)
data_test <- data %>% filter(Year > 2022)
n_test <- nrow(data_test)

add_lag <- function(eqtn, var, p){
  if(str_ends(eqtn, "~")){
    eqtn <- paste0(eqtn, " lag(",var,",",p,")")
  } else{
    eqtn <- paste0(eqtn, " + lag(",var,",",p,")")
  }
  return(eqtn)
}

RMSE_out_of_sample <- function(mdl, data_test, data, printout = T){
  data$prediction <- predict(mdl, data)
  data_test <- left_join(data_test, data %>% select(Year, Month, prediction)) %>%
    select(Year, Month, Change_CPI, prediction) %>% filter(complete.cases(.))
  npredictions <- sum(!is.na(data_test$prediction))
  lastmonth <- paste(data_test$Year[nrow(data_test)],data_test$Month[nrow(data_test)], sep = "-")
  rmse <- sqrt(sum((data_test$Change_CPI - data_test$prediction)**2,na.rm = T))
  if(printout){
    print(paste("Number of Predicted Terms:", npredictions))
    print(paste("Last predicted month:", lastmonth))
    print(paste("RMSE:", round(rmse, 5)))
  }
  return(rmse)
}
```

# Prediction 1: Fitting a simple VAR model on historical data

```{r}
p <- 2 # Number of lags
exp_vars <- c("Change_OilPrice", "Change_GasPrice") 
frml <- "Change_CPI ~"
for(v in exp_vars){
  for(i in 0:p){
    frml <- add_lag(frml, v, i)
  }
}

mdl <- lm(as.formula(frml), data_train)
summary(mdl)
RMSE_out_of_sample(mdl, data_test, data)

```


## Deciding number of lags 

## Adding seasonality

# Prediction 2: Fitting a simple VAR on last 5 years only

# Prediction 3: Deciding the window of VAR training by performance

# Prediction 4: Adding Import/Export Data

# Prediction 5: Paper Replication
